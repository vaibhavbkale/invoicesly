<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>New Sales Bill – Invoicely</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/app.css" rel="stylesheet">
    <!-- Axios CDN -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<div class="wrapper">
    <nav id="sidebar" class="sidebar js-sidebar">
        <div class="sidebar-content js-simplebar">
            <a class="sidebar-brand" href="index.html">
                <span class="align-middle">INVOICELY</span>
            </a>
            <ul class="sidebar-nav">
                <li class="sidebar-item ">
                    <a class="sidebar-link" href="index.html">
                        <i class="align-middle" data-feather="sliders"></i>
                        <span class="align-middle">Dashboard</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a class="sidebar-link" href="invoices.html">
                        <i class="align-middle" data-feather="file-text"></i>
                        <span class="align-middle">Invoice List</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a class="sidebar-link" href="Purchase-Invoice.html">
                        <i class="align-middle" data-feather="plus-circle"></i>
                        <span class="align-middle">Create Purchase Invoice</span>
                    </a>
                </li>
                <li class="sidebar-item active">
                    <a class="sidebar-link" href="Sales-Invoice.html">
                        <i class="align-middle" data-feather="plus-circle"></i>
                        <span class="align-middle">Create Sales Invoice</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a class="sidebar-link" href="settings.html">
                        <i class="align-middle" data-feather="settings"></i>
                        <span class="align-middle">Settings</span>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main">
        <main class="content">
            <div class="container-fluid p-0">
                <h1 class="h3 mb-3">Create New Sales Bill</h1>
                <div class="card">
                    <div class="card-body" id="printArea">

                        <!-- Invoice Info -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <label class="form-label">Invoice No.</label>
                                <input type="text" id="invoiceNo" class="form-control" placeholder="01/25-26">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">e-Way Bill No.</label>
                                <input type="text" id="ewayBillNo" class="form-control">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Date</label>
                                <input type="date" id="invoiceDate" class="form-control">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Vehicle No.</label>
                                <input type="text" id="vehicleNo" class="form-control" placeholder="MH15WJ2878">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Driver Number</label>
                                <input type="text" id="driverNo" class="form-control" placeholder="+91 000000000">
                            </div>
                        </div>

                        <!-- Supplier & Customer Info -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h5 class="section-title">Supplier</h5>
                                <input type="text" id="supplierFirmName" class="form-control mb-2" placeholder="Firm Name">
                                <input type="text" id="supplierContactNo" class="form-control mb-2" placeholder="Contact Number">
                                <input type="text" id="supplierAddress" class="form-control mb-2" placeholder="Address">
                                <input type="text" id="supplierGstin" class="form-control mb-2" placeholder="GSTIN/UIN">
                            </div>
                            <div class="col-md-6">
                                <h5 class="section-title">Customer</h5>
                                <input type="text" id="customerName" class="form-control mb-2" placeholder="Customer Name">
                                <input type="text" id="customerContactNo" class="form-control mb-2" placeholder="Contact Number">
                                <input type="text" id="customerAddress" class="form-control mb-2" placeholder="Address">
                                <input type="text" id="customerGstin" class="form-control mb-2" placeholder="GSTIN/UIN">
                            </div>
                        </div>

                        <!-- Product Table -->
                        <h5 class="section-title">Item Details</h5>
                        <table class="table table-bordered" id="productTable">
                            <thead>
                            <tr>
                                <th>Sl No.</th>
                                <th>Description of Goods</th>
                                <th>HSN/SAC</th>
                                <th>Quantity (kg)</th>
                                <th>Rate (₹)</th>
                                <th>NOS</th>
                                <th>Disc %</th>
                                <th>Amount (₹)</th>
                            </tr>
                            </thead>
                            <tbody id="itemTable">
                            <tr>
                                <td>1</td>
                                <td><input type="text" class="form-control desc" value="#"></td>
                                <td><input type="text" class="form-control hsn" value="#"></td>
                                <td><input type="number" class="form-control qty" value="#"></td>
                                <td><input type="number" class="form-control rate" value=""></td>
                                <td><input type="text" class="form-control nos" value=""></td>
                                <td><input type="number" class="form-control disc" value="0"></td>
                                <td><input type="text" class="form-control amount" readonly></td>
                            </tr>
                            </tbody>
                        </table>
                        <div class="mb-3">
                            <button type="button" class="btn btn-secondary" onclick="addRow()">+ Add Item</button>
                        </div>

                        <!-- Totals -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label class="form-label">Round Off (₹)</label>
                                <input type="number" id="roundOff" class="form-control" value="0.24">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Total</label>
                                <input type="text" id="netTotal" class="form-control">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Received Amount (₹)</label>
                                <input type="text" id="ReceivedAmount" class="form-control">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Pending Amount (₹)</label>
                                <input type="text" id="PendingAmount" class="form-control" readonly>
                            </div>
                        </div>

                        <div class="col-mb-3">
                            <label class="form-label">Amount in Words</label>
                            <input type="text" id="amountWords" class="form-control" readonly>
                        </div>

                        <div class="text-end mt-4">
                            <button type="button" class="btn btn-success" onclick="calculateTotals()">Calculate</button>
                            <button type="button" class="btn btn-primary" onclick="saveInvoice()">Save Invoice</button>
                            <button type="button" class="btn btn-secondary" onclick="printBill()">Print Bill</button>
                        </div>

                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
    function addRow() {
      let table = document.getElementById("itemTable");
      let rowCount = table.rows.length;
      let row = table.insertRow();
      row.innerHTML = `
        <td>${rowCount + 1}</td>
        <td><input type="text" class="form-control desc"></td>
        <td><input type="text" class="form-control hsn"></td>
        <td><input type="number" class="form-control qty"></td>
        <td><input type="number" class="form-control rate"></td>
        <td><input type="text" class="form-control nos"></td>
        <td><input type="number" class="form-control disc" value="0"></td>
        <td><input type="text" class="form-control amount" readonly></td>
      `;
    }

    function calculateTotals() {
      let rows = document.querySelectorAll("#itemTable tr");
      let grandTotal = 0;

      rows.forEach(row => {
        let qty = parseFloat(row.querySelector(".qty")?.value) || 0;
        let rate = parseFloat(row.querySelector(".rate")?.value) || 0;
        let disc = parseFloat(row.querySelector(".disc")?.value) || 0;

        let amount = qty * rate;
        let discount = (amount * disc) / 100;
        let finalAmount = amount - discount;

        if(row.querySelector(".amount")){
          row.querySelector(".amount").value = finalAmount.toFixed(2);
        }
        grandTotal += finalAmount;
      });

      let roundOff = parseFloat(document.getElementById("roundOff").value) || 0;
      let netTotal = grandTotal + roundOff;
      document.getElementById("netTotal").value = netTotal.toFixed(2);

      let received = parseFloat(document.getElementById("ReceivedAmount").value) || 0;
      document.getElementById("PendingAmount").value = (netTotal - received).toFixed(2);
      document.getElementById("amountWords").value = convertNumberToWords(netTotal);
    }

    function convertNumberToWords(amount) {
      const words = ["Zero","One","Two","Three","Four","Five","Six","Seven","Eight","Nine",
        "Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen","Seventeen","Eighteen","Nineteen"];
      const tens = ["","","Twenty","Thirty","Forty","Fifty","Sixty","Seventy","Eighty","Ninety"];

      function inWords(num) {
        if (num < 20) return words[num];
        if (num < 100) return tens[Math.floor(num/10)] + (num%10 ? " " + words[num%10] : "");
        if (num < 1000) return words[Math.floor(num/100)] + " Hundred " + (num%100 ? inWords(num%100) : "");
        if (num < 100000) return inWords(Math.floor(num/1000)) + " Thousand " + (num%1000 ? inWords(num%1000) : "");
        if (num < 10000000) return inWords(Math.floor(num/100000)) + " Lakh " + (num%100000 ? inWords(num%100000) : "");
        return num;
      }
      return "INR " + inWords(Math.floor(amount)) + " Only";
    }

    function printBill() {
      var printContents = document.getElementById("printArea").innerHTML;
      var originalContents = document.body.innerHTML;
      document.body.innerHTML = printContents;
      window.print();
      document.body.innerHTML = originalContents;
      location.reload();
    }

    // ✅ Save Invoice using Axios
    function saveInvoice() {
      calculateTotals(); // ensure totals are calculated

      let invoice = {
        invoiceNo: document.getElementById("invoiceNo").value,
        ewayBillNo: document.getElementById("ewayBillNo").value,
        invoiceDate: document.getElementById("invoiceDate").value,
        vehicleNo: document.getElementById("vehicleNo").value,
        driverNo: document.getElementById("driverNo").value,
        supplierFirmName: document.getElementById("supplierFirmName").value,
        supplierContactNo: document.getElementById("supplierContactNo").value,
        supplierAddress: document.getElementById("supplierAddress").value,
        supplierGstin: document.getElementById("supplierGstin").value,
        customerName: document.getElementById("customerName").value,
        customerContactNo: document.getElementById("customerContactNo").value,
        customerAddress: document.getElementById("customerAddress").value,
        customerGstin: document.getElementById("customerGstin").value,
        roundOff: document.getElementById("roundOff").value,
        netTotal: document.getElementById("netTotal").value,
        receivedAmount: document.getElementById("ReceivedAmount").value,
        pendingAmount: document.getElementById("PendingAmount").value,
        items: []
      };

      document.querySelectorAll("#itemTable tr").forEach(row => {
        invoice.items.push({
          description: row.querySelector(".desc")?.value || "",
          hsn: row.querySelector(".hsn")?.value || "",
          qty: parseFloat(row.querySelector(".qty")?.value) || 0,
          rate: parseFloat(row.querySelector(".rate")?.value) || 0,
          nos: row.querySelector(".nos")?.value || "",
          disc: parseFloat(row.querySelector(".disc")?.value) || 0,
          amount: parseFloat(row.querySelector(".amount")?.value) || 0
        });
      });

      axios.post("http://localhost:8080/api/sales", invoice)
        .then(res => {
          alert("✅ Invoice saved successfully!");
          console.log(res.data);
        })
        .catch(err => {
          console.error(err);
          alert("❌ Failed to save invoice!");
        });
    }
</script>
</body>
</html>
