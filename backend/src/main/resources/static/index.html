<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="description" content="Invoicely - Offline-first Invoice Dashboard" />

  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link rel="shortcut icon" href="img/icons/icon-48x48.png" />
  <title>Invoicely • Invoice-List</title>
  <link href="css/app.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet" />
  <style>
    .sync-indicator { display: inline-flex; align-items: center; gap: .35rem; padding: .25rem .6rem; border-radius: 999px; font-size: .8rem; }
    .status-dot { width: .5rem; height: .5rem; border-radius: 999px; display: inline-block; }
    .status-online { background: #28a745; }
    .status-offline { background: #dc3545; }
    .badge-pill { border-radius: 999px; }
    .table-small td, .table-small th { padding: .5rem .6rem; }
    .pointer { cursor: pointer; }
    .search-wrap { display: grid; grid-template-columns: 1fr auto; gap: .75rem; }
  </style>
</head>

<body>
  
 <div class="wrapper">
    <nav id="sidebar" class="sidebar js-sidebar">
      <div class="sidebar-content js-simplebar">
        <a class="sidebar-brand" href="index.html">
          <span class="align-middle">INVOICELY</span>
        </a>
        <ul class="sidebar-nav">
        
          <li class="sidebar-item active ">
            <a class="sidebar-link" href="index.html">
              <i class="align-middle" data-feather="sliders"></i>
              <span class="align-middle">Dashboard</span>
            </a>
          </li>
          <li class="sidebar-item">
            <a class="sidebar-link" href="invoices.html">
              <i class="align-middle" data-feather="file-text"></i>
              <span class="align-middle">Invoice List</span>
            </a>
          </li>
          <li class="sidebar-item">
            <a class="sidebar-link" href="Purchase-Invoice.html">
              <i class="align-middle" data-feather="plus-circle"></i>
              <span class="align-middle">Create Purchase Invoice</span>
            </a>
          </li>

           <li class="sidebar-item">
            <a class="sidebar-link" href="Sales-Invoice.html">
              <i class="align-middle" data-feather="plus-circle"></i>
              <span class="align-middle">Create Sales Invoice</span>
            </a>
          </li>
          <li class="sidebar-item">
            <a class="sidebar-link" href="settings.html">
              <i class="align-middle" data-feather="settings"></i>
              <span class="align-middle">Settings</span>
            </a>
          </li>
        </ul>
        <div class="sidebar-cta">
          <div class="sidebar-cta-content">
            <strong class="d-inline-block mb-2">Offline-first</strong>
            <div class="mb-2 text-sm">Works offline. Sync when you're back online.</div>
            <div class="small text-muted">Last Sync: <span id="lastSyncSide">—</span></div>
          </div>
        </div>
      </div>
    </nav>

    <div class="main">
      
      <nav class="navbar navbar-expand navbar-light navbar-bg">
        <a class="sidebar-toggle js-sidebar-toggle"><i class="hamburger align-self-center"></i></a>
        <div class="navbar-collapse collapse">
          <ul class="navbar-nav ms-auto align-items-center">
            <li class="nav-item me-3">
              <span id="onlineBadge" class="sync-indicator bg-light border">
                <span class="status-dot status-online" id="statusDot"></span>
                <span id="onlineText">Online</span>
              </span>
            </li>
            <li class="nav-item me-3">
              <span class="badge bg-secondary badge-pill">Pending Sync: <span id="pendingCount">0</span></span>
            </li>
            <li class="nav-item me-2">
              <button id="syncNowBtn" class="btn btn-sm btn-primary">Sync Now</button>
            </li>
            <li class="nav-item">
              <button id="themeToggle" class="btn btn-sm btn-outline-secondary" title="Toggle theme">
                <i data-feather="moon"></i>
              </button>
            </li>
          </ul>
        </div>
      </nav>

      <main class="content">
        <div class="container-fluid p-0">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h1 class="h3 mb-0"><strong>Invoice List</strong></h1>
            <div class="d-flex gap-2">
              <a href="Sales-Invoice.html" class="btn btn-success">
                <i data-feather="plus"></i> Create New Invoice
              </a>
            </div>
          </div>


    <!-- ✅ Metrics Cards Row (added) -->
    <div class="row mb-4">
      <div class="col-sm-6 col-xl-3">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Total Invoices</h5>
            <h2 class="mb-0" id="totalInvoices">0</h2>
          </div>
        </div>
      </div>
      <div class="col-sm-6 col-xl-3">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Pending Sync</h5>
            <h2 class="mb-0" id="pendingInvoices">0</h2>
          </div>
        </div>
      </div>
      <div class="col-sm-6 col-xl-3">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Revenue</h5>
            <h2 class="mb-0" id="revenueSum">0</h2>
          </div>
        </div>
      </div>
      <div class="col-sm-6 col-xl-3">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Drafts</h5>
            <h2 class="mb-0" id="draftCount">0</h2>
          </div>
        </div>
      </div>
    </div>
    <!-- ✅ End Metrics Row -->

          
          <!-- Search + Recent Invoices -->
          <div class="row">
            <div class="col-lg-8 d-flex">
              <div class="card flex-fill">
                <div class="card-header d-flex align-items-center justify-content-between">
                  <h5 class="card-title mb-0">Recent Invoices</h5>
                  <small class="text-muted">Last Sync: <span id="lastSyncTop">—</span></small>
                </div>
                <div class="card-body">
                  <div class="search-wrap mb-3">
                    <input id="searchInput" type="search" class="form-control" placeholder="Search by number, client or date (YYYY-MM-DD)" />
                    <button id="clearSearch" class="btn btn-outline-secondary">Clear</button>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-hover table-striped table-small align-middle mb-0" id="recentTable">
                      <thead>
                        <tr>
                          <th>#</th>
                          <th>Date</th>
                          <th>Client</th>
                          <th class="text-end">Total (₹)</th>
                          <th>Status</th>
                          <th class="text-end">Actions</th>
                        </tr>
                      </thead>
                      <tbody id="recentTbody">
                        <!-- Rows injected by JS -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4 d-flex">
              <div class="card flex-fill w-100">
                <div class="card-header">
                  <h5 class="card-title mb-0">Monthly Totals</h5>
                </div>
                <div class="card-body d-flex w-100">
                  <div class="align-self-center chart chart-lg w-100">
                    <canvas id="chartjs-dashboard-bar"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Status Distribution + Tips -->
          <div class="row">
            <div class="col-md-6 d-flex">
              <div class="card flex-fill w-100">
                <div class="card-header">
                  <h5 class="card-title mb-0">Status Distribution</h5>
                </div>
                <div class="card-body">
                  <div class="chart chart-xs"><canvas id="chartjs-dashboard-pie"></canvas></div>
                  <div class="small text-muted mt-2">Breakdown of Draft, Pending Sync, Synced</div>
                </div>
              </div>
            </div>
            <div class="col-md-6 d-flex">
              <div class="card flex-fill">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h5 class="card-title mb-0">Quick Tips</h5>
                  <span class="badge bg-info">GST</span>
                </div>
                <div class="card-body">
                  <ul class="mb-0">
                    <li>Auto-detect CGST/SGST vs IGST from Place of Supply vs Seller State.</li>
                    <li>Use <strong>Settings</strong> to pre-fill Seller details and default GST rate.</li>
                    <li>Press <kbd>Ctrl</kbd> + <kbd>S</kbd> to save a draft locally.</li>
                    <li>Invoices created offline will appear as <em>Pending Sync</em>.</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <footer class="footer">
        <div class="container-fluid">
          <div class="row text-muted">
            <div class="col-6 text-start">
              <p class="mb-0">
                <a class="text-muted" href="#" target="_blank"><strong>Invoicely</strong></a> — Offline Invoice App &copy;
              </p>
            </div>
            <div class="col-6 text-end">
              <ul class="list-inline mb-0">
                <li class="list-inline-item"><span id="footerOnline">Online</span></li>
                <li class="list-inline-item">v<span id="appVersion">1.0.0</span></li>
              </ul>
            </div>
          </div>
        </div>
      </footer>
    </div>
  </div>

  <script src="js/app.js"></script>
  <script>
    // --- Minimal offline/storage layer (localStorage) ---
    const LS_KEYS = { invoices: 'invoicely_invoices', lastSync: 'invoicely_last_sync', theme: 'invoicely_theme' };

    function seedIfEmpty() {
      const existing = JSON.parse(localStorage.getItem(LS_KEYS.invoices) || '[]');
      if (existing.length) return existing;
      const today = new Date();
      const fmt = (d) => d.toISOString().slice(0, 10);
      const demo = [
        { id: 'INV-001', date: fmt(new Date(today.getFullYear(), today.getMonth(), today.getDate()-1)), client: 'Acme Pvt Ltd', total: 15450, status: 'Synced', synced: true },
        { id: 'INV-002', date: fmt(new Date(today.getFullYear(), today.getMonth(), today.getDate()-2)), client: 'Globex', total: 8999, status: 'Pending Sync', synced: false },
        { id: 'INV-003', date: fmt(new Date(today.getFullYear(), today.getMonth(), today.getDate()-5)), client: 'Initech', total: 1200, status: 'Draft', synced: false },
        { id: 'INV-004', date: fmt(new Date(today.getFullYear(), today.getMonth()-1, 12)), client: 'Wayne Enterprises', total: 22000, status: 'Synced', synced: true },
        { id: 'INV-005', date: fmt(new Date(today.getFullYear(), today.getMonth()-2, 26)), client: 'Hooli', total: 5400, status: 'Synced', synced: true },
        { id: 'INV-006', date: fmt(new Date(today.getFullYear(), today.getMonth(), today.getDate())), client: 'Stark Industries', total: 32000, status: 'Pending Sync', synced: false }
      ];
      localStorage.setItem(LS_KEYS.invoices, JSON.stringify(demo));
      return demo;
    }

    function getInvoices() { return JSON.parse(localStorage.getItem(LS_KEYS.invoices) || '[]'); }
    function saveInvoices(arr) { localStorage.setItem(LS_KEYS.invoices, JSON.stringify(arr)); }

    // --- UI helpers ---
    function formatINR(n) { return (n||0).toLocaleString('en-IN', { maximumFractionDigits: 2 }); }
    function setText(id, text) { const el = document.getElementById(id); if (el) el.textContent = text; }

    // --- Online/Offline ---
    function refreshOnlineStatus() {
      const online = navigator.onLine;
      const dot = document.getElementById('statusDot');
      const txt = document.getElementById('onlineText');
      const footer = document.getElementById('footerOnline');
      if (online) {
        dot.classList.remove('status-offline');
        dot.classList.add('status-online');
        txt.textContent = 'Online';
        footer.textContent = 'Online';
      } else {
        dot.classList.remove('status-online');
        dot.classList.add('status-offline');
        txt.textContent = 'Offline';
        footer.textContent = 'Offline';
      }
    }
    window.addEventListener('online', refreshOnlineStatus);
    window.addEventListener('offline', refreshOnlineStatus);

    // --- Metrics + Tables ---
    function computeMetrics(list) {
      const total = list.length;
      const pending = list.filter(i => !i.synced && i.status !== 'Draft').length;
      const drafts = list.filter(i => i.status === 'Draft').length;
      const revenue = list.filter(i => i.status !== 'Draft').reduce((s,i)=> s + (Number(i.total)||0), 0);
      return { total, pending, drafts, revenue };
    }

    function renderTopCards(metrics) {
      setText('totalInvoices', metrics.total);
      setText('pendingInvoices', metrics.pending);
      setText('revenueSum', formatINR(metrics.revenue));
      setText('draftCount', metrics.drafts);
      setText('pendingCount', metrics.pending);
    }

    function renderRecentTable(list) {
      const tbody = document.getElementById('recentTbody');
      if (!tbody) return;
      tbody.innerHTML = '';
      list.slice(0, 10).forEach(inv => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="fw-bold">${inv.id}</td>
          <td>${inv.date}</td>
          <td>${inv.client}</td>
          <td class="text-end">${formatINR(inv.total)}</td>
          <td>
            ${inv.status === 'Synced' ? '<span class="badge bg-success">Synced</span>' : inv.status === 'Draft' ? '<span class="badge bg-warning">Draft</span>' : '<span class="badge bg-info">Pending Sync</span>'}
          </td>
          <td class="text-end">
            <div class="btn-group btn-group-sm">
              <a class="btn btn-outline-secondary" href="#" title="Preview"><i data-feather="eye"></i></a>
              <a class="btn btn-outline-primary" href="new-invoice.html?id=${encodeURIComponent(inv.id)}" title="Edit"><i data-feather="edit"></i></a>
              <button class="btn btn-outline-success" title="Export PDF"><i data-feather="download"></i></button>
              <button class="btn btn-outline-danger" data-id="${inv.id}" title="Delete" onclick="deleteInvoice('${inv.id}')"><i data-feather="trash-2"></i></button>
            </div>
          </td>`;
        tbody.appendChild(tr);
      });
      if (window.feather) feather.replace();
    }

    function deleteInvoice(id) {
      const list = getInvoices().filter(i => i.id !== id);
      saveInvoices(list);
      refreshAll();
    }

    // --- Simple Sync (mock) ---
    function syncNow() {
      const list = getInvoices();
      // mock: mark all non-draft as synced if online
      if (!navigator.onLine) {
        alert('You are offline. Changes will stay pending.');
        return;
      }
      const updated = list.map(i => ({ ...i, synced: i.status === 'Draft' ? false : true, status: i.status === 'Draft' ? 'Draft' : 'Synced' }));
      saveInvoices(updated);
      const ts = new Date().toISOString();
      localStorage.setItem(LS_KEYS.lastSync, ts);
      setText('lastSyncTop', new Date(ts).toLocaleString());
      setText('lastSyncSide', new Date(ts).toLocaleString());
      refreshAll();
    }

    // --- Charts ---
    function buildMonthlyData(list) {
      const byMonth = new Array(12).fill(0);
      list.forEach(inv => {
        const m = new Date(inv.date).getMonth();
        byMonth[m] += Number(inv.total)||0;
      });
      return byMonth.map(v => Math.round(v));
    }

    function renderCharts(list) {
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      // Bar chart: monthly totals
      new Chart(document.getElementById('chartjs-dashboard-bar'), {
        type: 'bar',
        data: { labels: months, datasets: [{ label: 'Totals (₹)', backgroundColor: window.theme.primary, borderColor: window.theme.primary, data: buildMonthlyData(list), barPercentage: .75, categoryPercentage: .5 }] },
        options: { maintainAspectRatio: false, legend: { display: false }, scales: { yAxes: [{ gridLines: { display: false }, ticks: { callback: (v)=>'₹'+v.toLocaleString('en-IN') } }], xAxes: [{ gridLines: { color: 'transparent' } }] } }
      });

      // Pie chart: status distribution
      const draft = list.filter(i=>i.status==='Draft').length;
      const pending = list.filter(i=>!i.synced && i.status!=='Draft').length;
      const synced = list.filter(i=>i.synced).length;
      new Chart(document.getElementById('chartjs-dashboard-pie'), {
        type: 'pie',
        data: { labels: ['Draft','Pending Sync','Synced'], datasets: [{ data: [draft, pending, synced], backgroundColor: [window.theme.warning, window.theme.info, window.theme.success], borderWidth: 5 }] },
        options: { responsive: !window.MSInputMethodContext, maintainAspectRatio: false, legend: { display: true }, cutoutPercentage: 60 }
      });
    }

    // --- Theme toggle (light/dark) ---
    function applyTheme() {
      const theme = localStorage.getItem(LS_KEYS.theme) || 'light';
      document.documentElement.setAttribute('data-theme', theme);
    }

    // --- Search ---
    function applySearch(list) {
      const q = document.getElementById('searchInput').value.trim().toLowerCase();
      if (!q) return list;
      return list.filter(inv =>
        inv.id.toLowerCase().includes(q) ||
        inv.client.toLowerCase().includes(q) ||
        (inv.date && inv.date.includes(q))
      );
    }

    // --- Refresh cycle ---
    let chartsDrawn = false;
    function refreshAll() {
      refreshOnlineStatus();
      const full = getInvoices();
      const filtered = applySearch(full);
      const metrics = computeMetrics(full);
      renderTopCards(metrics);
      renderRecentTable(filtered.sort((a,b)=> new Date(b.date) - new Date(a.date)));
      if (!chartsDrawn) { renderCharts(full); chartsDrawn = true; }
      const lastSync = localStorage.getItem(LS_KEYS.lastSync);
      setText('lastSyncTop', lastSync ? new Date(lastSync).toLocaleString() : '—');
      setText('lastSyncSide', lastSync ? new Date(lastSync).toLocaleString() : '—');
    }

    document.addEventListener('DOMContentLoaded', function() {
      // seed
      seedIfEmpty();
      // theme
      applyTheme();
      document.getElementById('themeToggle').addEventListener('click', ()=>{
        const current = localStorage.getItem(LS_KEYS.theme) || 'light';
        const next = current === 'light' ? 'dark' : 'light';
        localStorage.setItem(LS_KEYS.theme, next);
        applyTheme();
      });
      // search listeners
      document.getElementById('searchInput').addEventListener('input', refreshAll);
      document.getElementById('clearSearch').addEventListener('click', ()=>{ document.getElementById('searchInput').value=''; refreshAll(); });
      // sync btn
      document.getElementById('syncNowBtn').addEventListener('click', syncNow);
      // first paint
      refreshAll();
      if (window.feather) feather.replace();
    });
  </script>
</body>
</html>
