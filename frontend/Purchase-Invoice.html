<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>New Purchase Bill – Invoicely</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/app.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<div class="wrapper">
    <nav id="sidebar" class="sidebar js-sidebar">
        <div class="sidebar-content js-simplebar">
            <a class="sidebar-brand" href="index.html"><span class="align-middle">INVOICELY</span></a>
            <ul class="sidebar-nav">
                <li class="sidebar-item"><a class="sidebar-link" href="index.html">Dashboard</a></li>
                <li class="sidebar-item"><a class="sidebar-link" href="Sales_invoices_List.html">Sales Invoice List</a></li>
                <li class="sidebar-item"><a class="sidebar-link" href="Purchase_invoices_List.html">Purchase Invoice List</a></li>
                <li class="sidebar-item active"><a class="sidebar-link" href="Purchase-Invoice.html">Create Purchase Invoice</a></li>
                <li class="sidebar-item"><a class="sidebar-link" href="Sales-Invoice.html">Create Sales Invoice</a></li>
                <li class="sidebar-item"><a class="sidebar-link" href="settings.html">Settings</a></li>
            </ul>
        </div>
    </nav>

    <div class="main">
        <nav class="navbar navbar-expand navbar-light navbar-bg">
            <div class="navbar-collapse collapse">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item me-2">
                        <button id="syncNowBtn" class="btn btn-sm btn-primary">Sync Now</button>
                    </li>
                </ul>
            </div>
        </nav>

        <main class="content">
            <div class="container-fluid p-0">
                <h1 class="h3 mb-3">Create New Purchase Bill</h1>
                <div class="card">
                    <div class="card-body" id="printArea">

                        <!-- Supplier & Self Info -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h5 class="section-title">Supplier Details</h5>
                                <input type="text" class="form-control mb-2" id="supplierName" placeholder="Firm Owner Name">
                                <input type="text" class="form-control mb-2" id="supplierMobile" placeholder="Mobile No.">
                                <input type="text" class="form-control mb-2" id="supplierAddress" placeholder="Address">
                            </div>
                            <div class="col-md-6">
                                <h5 class="section-title">Self Details</h5>
                                <input type="text" class="form-control mb-2" id="companyName" placeholder="Enter Company Name">
                                <input type="text" class="form-control mb-2" id="companyMobile" placeholder="Mobile No.">
                                <input type="text" class="form-control mb-2" id="companyAddress" placeholder="Address">
                            </div>
                        </div>

                        <hr>

                        <!-- Product Table -->
                        <h5 class="section-title">Product Details</h5>
                        <table class="table table-bordered" id="productTable">
                            <thead>
                            <tr>
                                <th>Item Name</th>
                                <th>Weight (kg)</th>
                                <th>Price/kg</th>
                                <th>GST %</th>
                                <th>Shortage (Kg)</th>
                                <th>Chotari (%)</th>
                                <th>Weight Charges (₹)</th>
                                <th>Action</th>
                            </tr>
                            </thead>
                            <tbody id="productBody">
                            <tr>
                                <td><input type="text" class="form-control ItemName" required></td>
                                <td><input type="number" class="form-control qty" required></td>
                                <td><input type="number" class="form-control cost" step="0.01" required></td>
                                <td><input type="number" class="form-control gst" step="0.01" required></td>
                                <td><input type="number" class="form-control shortageKg" step="0.01"></td>
                                <td><input type="number" class="form-control chotari" step="0.01"></td>
                                <td><input type="number" class="form-control wCharges" step="0.01"></td>
                                <td><button type="button" class="btn btn-danger btn-sm removeRow">X</button></td>
                            </tr>
                            </tbody>
                        </table>
                        <button type="button" class="btn btn-secondary" id="addRow">+ Add Product</button>

                        <hr>

                        <!-- GST & Totals -->
                        <div class="row g-3 mt-1">
                            <div class="col-md-3"><label>SGST Amount</label><input type="number" step="0.01" class="form-control" id="sgst" readonly></div>
                            <div class="col-md-3"><label>CGST Amount</label><input type="number" step="0.01" class="form-control" id="cgst" readonly></div>
                            <div class="col-md-3"><label>Total GST</label><input type="number" step="0.01" class="form-control" id="totalGst" readonly></div>
                        </div>

                        <div class="row g-3 mt-3">
                            <div class="col-md-3"><label>Shortage Amount (₹)</label><input type="number" class="form-control total-box" id="shortageAmt" readonly></div>
                            <div class="col-md-3"><label>Chotari Amount (₹)</label><input type="number" class="form-control total-box" id="chotariAmt" readonly></div>
                            <div class="col-md-3"><label>Weight Charges Deducted (₹)</label><input type="number" class="form-control total-box" id="weightChargeAmt" readonly></div>
                            <div class="col-md-3"><label>Net Total (₹)</label><input type="number" step="0.01" class="form-control total-box" id="netTotal" readonly></div>
                        </div>

                        <hr>

                        <!-- Vehicle Details -->
                        <div class="col-md-6">
                            <input type="text" class="form-control mb-2" id="vehicleNo" placeholder="Vehicle Number">
                            <input type="text" class="form-control mb-2" id="driverMobile" placeholder="Driver Contact Number">
                            <input type="text" class="form-control mb-2" id="driverName" placeholder="Driver Name">
                        </div>

                        <!-- Buttons -->
                        <div class="text-end mt-4">
                            <button type="button" class="btn btn-success" id="saveInvoice">Save Purchase Bill</button>
                            <button type="button" class="btn btn-primary" onclick="printBill()">Print Bill</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Add Row
    document.getElementById("addRow").addEventListener("click", () => {
        let row = document.querySelector("#productBody tr").cloneNode(true);
        row.querySelectorAll("input").forEach(i => i.value = "");
        document.getElementById("productBody").appendChild(row);
        bindRowEvents(row);
    });

    // Bind row events
    function bindRowEvents(row) {
        row.querySelectorAll("input").forEach(input => input.addEventListener("input", calculateTotals));
        row.querySelector(".removeRow").addEventListener("click", () => {
            row.remove();
            calculateTotals();
        });
    }

    // Bind initial row
    document.querySelectorAll("#productBody tr").forEach(row => bindRowEvents(row));

    // Calculate totals
    function calculateTotals() {
        let totalSGST = 0, totalCGST = 0, totalGST = 0;
        let totalShortage = 0, totalChotari = 0, totalWeightCharges = 0, finalNet = 0;

        document.querySelectorAll("#productBody tr").forEach(row => {
            let qty = parseFloat(row.querySelector(".qty").value) || 0;
            let cost = parseFloat(row.querySelector(".cost").value) || 0;
            let gst = parseFloat(row.querySelector(".gst").value) || 0;
            let shortageKg = parseFloat(row.querySelector(".shortageKg").value) || 0;
            let chotari = parseFloat(row.querySelector(".chotari").value) || 0;
            let wCharges = parseFloat(row.querySelector(".wCharges").value) || 0;

            let actualQty = Math.max(0, qty - shortageKg);
            let subTotal = actualQty * cost;

            let gstAmount = (subTotal * gst) / 100;
            let sgstAmount = gstAmount / 2;
            let cgstAmount = gstAmount / 2;

            let shortageAmt = shortageKg * cost;
            let chotariAmt = (subTotal * chotari) / 100;

            let rowTotal = subTotal + gstAmount - chotariAmt + wCharges;

            totalSGST += sgstAmount;
            totalCGST += cgstAmount;
            totalGST += gstAmount;
            totalShortage += shortageAmt;
            totalChotari += chotariAmt;
            totalWeightCharges += wCharges;
            finalNet += rowTotal;
        });

        document.getElementById("sgst").value = totalSGST.toFixed(2);
        document.getElementById("cgst").value = totalCGST.toFixed(2);
        document.getElementById("totalGst").value = totalGST.toFixed(2);
        document.getElementById("shortageAmt").value = totalShortage.toFixed(2);
        document.getElementById("chotariAmt").value = totalChotari.toFixed(2);
        document.getElementById("weightChargeAmt").value = totalWeightCharges.toFixed(2);
        document.getElementById("netTotal").value = finalNet.toFixed(2);
    }

    // Print Bill
    function printBill() {
        let printContents = document.getElementById("printArea").innerHTML;
        let newWin = window.open("", "_blank");
        newWin.document.write(`<html><head><title>Print Bill</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
            </head><body>${printContents}</body></html>`);
        newWin.print();
        newWin.close();
    }

    // Save Invoice to backend
    document.getElementById("saveInvoice").addEventListener("click", () => {
        let items = [];
        document.querySelectorAll("#productBody tr").forEach(row => {
            items.push({
                itemName: row.querySelector(".ItemName").value,
                weightKg: parseFloat(row.querySelector(".qty").value) || 0,
                pricePerKg: parseFloat(row.querySelector(".cost").value) || 0,
                gstPercent: parseFloat(row.querySelector(".gst").value) || 0,
                shortageKg: parseFloat(row.querySelector(".shortageKg").value) || 0,
                chotariPercent: parseFloat(row.querySelector(".chotari").value) || 0,
                weightCharges: parseFloat(row.querySelector(".wCharges").value) || 0
            });
        });

        let invoice = {
            supplierFirmOwnerName: document.getElementById("supplierName").value,
            supplierMobile: document.getElementById("supplierMobile").value,
            supplierAddress: document.getElementById("supplierAddress").value,
            companyId: null, // optional field
            sgst: parseFloat(document.getElementById("sgst").value) || 0,
            cgst: parseFloat(document.getElementById("cgst").value) || 0,
            weightShortageAmount: parseFloat(document.getElementById("shortageAmt").value) || 0,
            chotariAmount: parseFloat(document.getElementById("chotariAmt").value) || 0,
            weightChargesDeducted: parseFloat(document.getElementById("weightChargeAmt").value) || 0,
            finalNetTotal: parseFloat(document.getElementById("netTotal").value) || 0,
            vehicleNumber: document.getElementById("vehicleNo").value,
            driverContactNumber: document.getElementById("driverMobile").value,
            driverName: document.getElementById("driverName").value,
            itemsJson: JSON.stringify(items)
        };

        axios.post("/api/purchases", invoice)
            .then(res => {
                alert("Purchase Invoice Saved! ID: " + res.data.id);
                location.reload();
            })
            .catch(err => {
                console.error(err);
                alert("Error saving invoice!");
            });
    });
</script>
</body>
</html>
