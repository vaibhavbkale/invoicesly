<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Update Sales Bill – Invoicely</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/app.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<div class="wrapper">
    <div class="wrapper">
        <nav id="sidebar" class="sidebar js-sidebar">
            <div class="sidebar-content js-simplebar">
                <a class="sidebar-brand" href="index.html">
                    <span class="align-middle">INVOICELY</span>
                </a>
                <ul class="sidebar-nav">

                    <li class="sidebar-item  ">
                        <a class="sidebar-link" href="index.html">
                            <i class="align-middle" data-feather="sliders"></i>
                            <span class="align-middle">Dashboard</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a class="sidebar-link" href="Sales_invoices_List.html">
                            <i class="align-middle" data-feather="file-text"></i>
                            <span class="align-middle">Sales Invoice List</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a class="sidebar-link" href="Purchase_invoices_List.html">
                            <i class="align-middle" data-feather="file-text"></i>
                            <span class="align-middle">Purchase Invoice List</span>
                        </a>
                    </li>

                    <li class="sidebar-item">
                        <a class="sidebar-link" href="Purchase-Invoice.html">
                            <i class="align-middle" data-feather="plus-circle"></i>
                            <span class="align-middle">Create Purchase Invoice</span>
                        </a>
                    </li>

                    <li class="sidebar-item">
                        <a class="sidebar-link" href="Sales-Invoice.html">
                            <i class="align-middle" data-feather="plus-circle"></i>
                            <span class="align-middle">Create Sales Invoice</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a class="sidebar-link" href="settings.html">
                            <i class="align-middle" data-feather="settings"></i>
                            <span class="align-middle">Settings</span>
                        </a>
                    </li>
                </ul>
                <div class="sidebar-cta">
                    <div class="sidebar-cta-content">
                        <strong class="d-inline-block mb-2">Offline-first</strong>
                        <div class="mb-2 text-sm">Works offline. Sync when you're back online.</div>
                        <div class="small text-muted">Last Sync: <span id="lastSyncSide">—</span></div>
                    </div>
                </div>
            </div>
        </nav>

    <div class="main">
        <main class="content">
            <div class="container-fluid p-0">
                <h1 class="h3 mb-3">Update Sales Bill</h1>
                <div class="card">
                    <div class="card-body" id="printArea">
                        <!-- Invoice Info -->
                        <div class="row mb-4">
                            <div class="col-md-3"><label>Invoice No.</label><input type="text" id="invoiceNo" class="form-control"></div>
                            <div class="col-md-3"><label>Date</label><input type="date" id="invoiceDate" class="form-control"></div>
                            <div class="col-md-3"><label>Vehicle No.</label><input type="text" id="vehicleNo" class="form-control"></div>
                            <div class="col-md-3"><label>Driver Number</label><input type="text" id="driverNo" class="form-control"></div>
                        </div>

                        <!-- Supplier & Customer Info -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h5>Supplier</h5>
                                <input type="text" id="supplierFirmName" class="form-control mb-2">
                                <input type="text" id="supplierContactNo" class="form-control mb-2">
                                <input type="text" id="supplierAddress" class="form-control mb-2">
                                <input type="text" id="supplierGstin" class="form-control mb-2">
                            </div>
                            <div class="col-md-6">
                                <h5>Customer</h5>
                                <input type="text" id="customerName" class="form-control mb-2">
                                <input type="text" id="customerContactNo" class="form-control mb-2">
                                <input type="text" id="customerAddress" class="form-control mb-2">
                                <input type="text" id="customerGstin" class="form-control mb-2">
                            </div>
                        </div>

                        <!-- Product Table -->
                        <h5>Item Details</h5>
                        <table class="table table-bordered" id="productTable">
                            <thead>
                            <tr>
                                <th>Sr No.</th><th>Description</th><th>HSN/SAC</th>
                                <th>Quantity</th><th>Rate</th><th>NOS</th>
                                <th>Disc %</th><th>Amount</th>
                            </tr>
                            </thead>
                            <tbody id="itemTable"></tbody>
                        </table>
                        <button class="btn btn-secondary mb-3" onclick="addRow()">+ Add Item</button>

                        <div class="row mb-3">
                            <div class="col-md-3"><label>Round Off</label><input type="number" id="roundOff" class="form-control"></div>
                            <div class="col-md-3"><label>Total</label><input type="text" id="total" class="form-control" readonly></div>
                            <div class="col-md-3"><label>Received</label><input type="number" id="receivedAmount" class="form-control"></div>
                            <div class="col-md-3"><label>Pending</label><input type="text" id="pendingAmount" class="form-control" readonly></div>
                        </div>

                        <div class="mb-3"><label>Amount in Words</label><input type="text" id="amountInWords" class="form-control" readonly></div>

                        <div class="text-end mt-4">
                            <button class="btn btn-success" onclick="calculateTotals()">Calculate</button>
                            <button class="btn btn-primary" onclick="updateInvoice()">Update Invoice</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
    const API_URL = "http://localhost:8080/api/sales";
    const params = new URLSearchParams(window.location.search);
    const invoiceId = params.get("id");

    function addRow(item={}) {
        const table = document.getElementById("itemTable");
        const rowCount = table.rows.length;
        const row = table.insertRow();
        row.innerHTML = `
            <td>${rowCount+1}</td>
            <td><input type="text" class="form-control desc" value="${item.description||''}"></td>
            <td><input type="text" class="form-control hsn" value="${item.hsnSac||''}"></td>
            <td><input type="number" class="form-control qty" value="${item.quantityKg||0}"></td>
            <td><input type="number" class="form-control rate" value="${item.rate||0}"></td>
            <td><input type="number" class="form-control nos" value="${item.nos||0}"></td>
            <td><input type="number" class="form-control disc" value="${item.discPercent||0}"></td>
            <td><input type="text" class="form-control amount" readonly value="${item.amount||0}"></td>
        `;
    }

    function calculateTotals() {
        let total = 0;
        document.querySelectorAll("#itemTable tr").forEach(row=>{
            const qty = parseFloat(row.querySelector(".qty")?.value)||0;
            const rate = parseFloat(row.querySelector(".rate")?.value)||0;
            const disc = parseFloat(row.querySelector(".disc")?.value)||0;
            let amount = qty*rate - (qty*rate*disc/100);
            row.querySelector(".amount").value = amount.toFixed(2);
            total += amount;
        });
        const roundOff = parseFloat(document.getElementById("roundOff").value)||0;
        const grandTotal = total + roundOff;
        document.getElementById("total").value = grandTotal.toFixed(2);
        const received = parseFloat(document.getElementById("receivedAmount").value)||0;
        document.getElementById("pendingAmount").value = (grandTotal-received).toFixed(2);
        document.getElementById("amountInWords").value = convertNumberToWords(grandTotal);
    }

    function convertNumberToWords(amount){
        const words = ["Zero","One","Two","Three","Four","Five","Six","Seven","Eight","Nine","Ten",
                       "Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen","Seventeen",
                       "Eighteen","Nineteen"];
        const tens = ["","","Twenty","Thirty","Forty","Fifty","Sixty","Seventy","Eighty","Ninety"];
        function inWords(num){
            if(num<20) return words[num];
            if(num<100) return tens[Math.floor(num/10)] + (num%10 ? " "+words[num%10] : "");
            if(num<1000) return words[Math.floor(num/100)]+" Hundred "+(num%100? inWords(num%100):"");
            if(num<100000) return inWords(Math.floor(num/1000))+" Thousand "+(num%1000? inWords(num%1000):"");
            if(num<10000000) return inWords(Math.floor(num/100000))+" Lakh "+(num%100000? inWords(num%100000):"");
            return num;
        }
        return inWords(Math.floor(amount)) + " Rupees Only";
    }

    // Fetch invoice by ID and populate fields
    async function loadInvoice(){
        try{
            const res = await axios.get(`${API_URL}/${invoiceId}`);
            const inv = res.data;
            document.getElementById("invoiceNo").value = inv.invoiceNo;
            document.getElementById("invoiceDate").value = inv.invoiceDate;
            document.getElementById("vehicleNo").value = inv.vehicleNo;
            document.getElementById("driverNo").value = inv.driverNo;
            document.getElementById("supplierFirmName").value = inv.supplierFirmName;
            document.getElementById("supplierContactNo").value = inv.supplierContactNo;
            document.getElementById("supplierAddress").value = inv.supplierAddress;
            document.getElementById("supplierGstin").value = inv.supplierGstin;
            document.getElementById("customerName").value = inv.customerName;
            document.getElementById("customerContactNo").value = inv.customerContactNo;
            document.getElementById("customerAddress").value = inv.customerAddress;
            document.getElementById("customerGstin").value = inv.customerGstin;
            document.getElementById("roundOff").value = inv.roundOff || 0;
            document.getElementById("receivedAmount").value = inv.receivedAmount || 0;

            // Populate items
            inv.items.forEach(item => addRow(item));
            calculateTotals();
        }catch(err){
            console.error(err);
            alert("Failed to load invoice data!");
        }
    }

    async function updateInvoice(){
        calculateTotals();
        const invoice = {
            invoiceNo: document.getElementById("invoiceNo").value,
            invoiceDate: document.getElementById("invoiceDate").value,
            vehicleNo: document.getElementById("vehicleNo").value,
            driverNo: document.getElementById("driverNo").value,
            supplierFirmName: document.getElementById("supplierFirmName").value,
            supplierContactNo: document.getElementById("supplierContactNo").value,
            supplierAddress: document.getElementById("supplierAddress").value,
            supplierGstin: document.getElementById("supplierGstin").value,
            customerName: document.getElementById("customerName").value,
            customerContactNo: document.getElementById("customerContactNo").value,
            customerAddress: document.getElementById("customerAddress").value,
            customerGstin: document.getElementById("customerGstin").value,
            roundOff: parseFloat(document.getElementById("roundOff").value)||0,
            total: parseFloat(document.getElementById("total").value)||0,
            receivedAmount: parseFloat(document.getElementById("receivedAmount").value)||0,
            pendingAmount: parseFloat(document.getElementById("pendingAmount").value)||0,
            amountInWords: document.getElementById("amountInWords").value,
            items: []
        };
        document.querySelectorAll("#itemTable tr").forEach((row,i)=>{
            invoice.items.push({
                srNo: i+1,
                description: row.querySelector(".desc")?.value||"",
                hsnSac: row.querySelector(".hsn")?.value||"",
                quantityKg: parseFloat(row.querySelector(".qty")?.value)||0,
                rate: parseFloat(row.querySelector(".rate")?.value)||0,
                nos: parseInt(row.querySelector(".nos")?.value)||0,
                discPercent: parseFloat(row.querySelector(".disc")?.value)||0,
                amount: parseFloat(row.querySelector(".amount")?.value)||0
            });
        });
        invoice.itemsJson = JSON.stringify(invoice.items);

        try{
            await axios.put(`${API_URL}/${invoiceId}`, invoice);
            alert("Invoice updated successfully!");
            window.location.href="Sales_invoices_List.html";
        }catch(err){

