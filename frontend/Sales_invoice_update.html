<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Update Purchase Invoice – Invoicely</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="css/app.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

  <style>
    .pointer { cursor: pointer; }
  </style>
</head>

<body>

<div class="wrapper">

  <!-- SIDEBAR -->
  <nav id="sidebar" class="sidebar js-sidebar">
    <div class="sidebar-content js-simplebar">
      <a class="sidebar-brand" href="index.html"><span>INVOICELY</span></a>
      <ul class="sidebar-nav">
        <li class="sidebar-item"><a class="sidebar-link" href="index.html">Dashboard</a></li>
        <li class="sidebar-item active"><a class="sidebar-link" href="#">Update Purchase Invoice</a></li>
        <li class="sidebar-item"><a class="sidebar-link" href="Purchase_invoices_List.html">Purchase List</a></li>
      </ul>
    </div>
  </nav>

  <!-- MAIN -->
  <div class="main">
    <main class="content">
      <div class="container-fluid p-0">

        <h1 class="h3 mb-3"><strong>Update Purchase Invoice</strong></h1>

        <!-- Supplier -->
        <div class="row mb-4">
          <div class="col-md-6">
            <h5>Supplier Details</h5>
            <input id="supplierName" class="form-control mb-2" placeholder="Supplier Name">
            <input id="supplierMobile" class="form-control mb-2" placeholder="Mobile">
            <input id="supplierAddress" class="form-control mb-2" placeholder="Address">
          </div>

          <!-- Company -->
          <div class="col-md-6">
            <h5>Self / Company Details</h5>
            <input id="companyName" class="form-control mb-2" readonly>
            <input id="companyMobile" class="form-control mb-2" readonly>
            <input id="companyAddress" class="form-control mb-2" readonly>
            <input id="companyGstin" class="form-control mb-2" readonly>
            <input id="companyAccountNumber" class="form-control mb-2" readonly>
            <input id="companyAccountHolder" class="form-control mb-2" readonly>
          </div>
        </div>

        <hr>

        <!-- Product Table -->
        <h5>Product Details</h5>

        <table class="table table-bordered">
          <thead>
          <tr>
            <th>Item</th>
            <th>Weight</th>
            <th>Price/kg</th>
            <th>GST%</th>
            <th>Shortage</th>
            <th>Chotari%</th>
            <th>Weight Charges</th>
            <th></th>
          </tr>
          </thead>
          <tbody id="productBody"></tbody>
        </table>

        <!-- Template -->
        <table style="display:none;">
          <tr id="rowTemplate">
            <td><input class="form-control itemName"></td>
            <td><input type="number" class="form-control weightKg"></td>
            <td><input type="number" class="form-control pricePerKg"></td>
            <td><input type="number" class="form-control gstPercent"></td>
            <td><input type="number" class="form-control shortageKg"></td>
            <td><input type="number" class="form-control chotariPercent"></td>
            <td><input type="number" class="form-control weightCharges"></td>
            <td><button class="btn btn-danger btn-sm removeRow">X</button></td>
          </tr>
        </table>

        <button class="btn btn-primary btn-sm mb-3" id="addRowBtn">+ Add Row</button>

        <hr>

        <!-- Totals -->
        <div class="row">
          <div class="col-md-3"><label>SGST</label><input id="sgst" class="form-control" readonly></div>
          <div class="col-md-3"><label>CGST</label><input id="cgst" class="form-control" readonly></div>
          <div class="col-md-3"><label>Total GST</label><input id="totalGst" class="form-control" readonly></div>
        </div>

        <div class="row mt-3">
          <div class="col-md-3"><label>Shortage Amount</label><input id="shortageAmt" class="form-control" readonly></div>
          <div class="col-md-3"><label>Chotari Amount</label><input id="chotariAmt" class="form-control" readonly></div>
          <div class="col-md-3"><label>Weight Charges</label><input id="weightChargeAmt" class="form-control" readonly></div>
          <div class="col-md-3"><label>Net Total</label><input id="netTotal" class="form-control" readonly></div>
        </div>

        <hr>

        <!-- Vehicle -->
        <div class="col-md-6">
          <input id="vehicleNo" class="form-control mb-2" placeholder="Vehicle No">
          <input id="driverMobile" class="form-control mb-2" placeholder="Driver Mobile">
          <input id="driverName" class="form-control mb-2" placeholder="Driver Name">
        </div>

        <button class="btn btn-success mt-4" id="updateBtn">Update Invoice</button>

      </div>
    </main>
  </div>
</div>

<script>
feather.replace();

// URL
const p = new URLSearchParams(window.location.search);
const invoiceId = p.get("id");

// Load Company Info
function loadCompany() {
  axios.get("http://localhost:8080/api/companies")
    .then(res => {
      if (res.data.length > 0) {
        let c = res.data[0];
        companyName.value = c.companyName;
        companyMobile.value = c.mobile;
        companyAddress.value = c.address;
        companyGstin.value = c.gstin;
        companyAccountNumber.value = c.accountnumber;
        companyAccountHolder.value = c.accountholdername;
      }
    });
}

// ⭐ FIX: Proper Event Binding for dynamic rows
function bindRowEvents(row) {
  row.querySelectorAll("input").forEach(inp => {
    inp.addEventListener("input", calculateTotals);
  });

  row.querySelector(".removeRow").addEventListener("click", () => {
    row.remove();
    calculateTotals();
  });
}

// Add Row
function addRow(item = {}) {
  const row = document.getElementById("rowTemplate").cloneNode(true);
  row.removeAttribute("id");
  row.style.display = "";

  row.querySelector(".itemName").value = item.itemName || "";
  row.querySelector(".weightKg").value = item.weightKg || "";
  row.querySelector(".pricePerKg").value = item.pricePerKg || "";
  row.querySelector(".gstPercent").value = item.gstPercent || "";
  row.querySelector(".shortageKg").value = item.shortageKg || "";
  row.querySelector(".chotariPercent").value = item.chotariPercent || "";
  row.querySelector(".weightCharges").value = item.weightCharges || "";

  // ⭐ Fixed: Now all rows bind events properly
  bindRowEvents(row);

  document.getElementById("productBody").appendChild(row);
}

// Load Invoice
function loadInvoice() {
  axios.get(`http://localhost:8080/api/purchases/${invoiceId}`)
    .then(res => {
      let d = res.data;

      supplierName.value = d.supplierFirmOwnerName;
      supplierMobile.value = d.supplierMobile;
      supplierAddress.value = d.supplierAddress;

      productBody.innerHTML = "";
      (d.items || []).forEach(item => addRow(item));

      sgst.value = d.sgst;
      cgst.value = d.cgst;
      totalGst.value = (d.sgst + d.cgst).toFixed(2);
      shortageAmt.value = d.weightShortageAmount;
      chotariAmt.value = d.chotariAmount;
      weightChargeAmt.value = d.weightChargesDeducted;
      netTotal.value = d.finalNetTotal;

      vehicleNo.value = d.vehicleNumber;
      driverMobile.value = d.driverContactNumber;
      driverName.value = d.driverName;
    });
}

// Totals with Correct Chotari Formula
function calculateTotals() {
  let tSGST = 0, tCGST = 0, tGST = 0;
  let tShort = 0, tChotari = 0, tWeightCharges = 0, tNet = 0;

  document.querySelectorAll("#productBody tr").forEach(row => {
    let weight = parseFloat(row.querySelector(".weightKg").value) || 0;
    let price = parseFloat(row.querySelector(".pricePerKg").value) || 0;
    let gst = parseFloat(row.querySelector(".gstPercent").value) || 0;
    let shortage = parseFloat(row.querySelector(".shortageKg").value) || 0;
    let chotari = parseFloat(row.querySelector(".chotariPercent").value) || 0;
    let weightCharges = parseFloat(row.querySelector(".weightCharges").value) || 0;

    let actualWeight = Math.max(0, weight - shortage);
    let subTotal = actualWeight * price;

    let gstAmt = subTotal * gst / 100;
    let sgstAmt = gstAmt / 2;
    let cgstAmt = gstAmt / 2;

    let shortageAmt = shortage * price;

    // ⭐ Correct Chotari formula
    let chotariAmt = (actualWeight * chotari) / 100;

    let rowTotal = subTotal + gstAmt - chotariAmt + weightCharges;

    tSGST += sgstAmt;
    tCGST += cgstAmt;
    tGST += gstAmt;
    tShort += shortageAmt;
    tChotari += chotariAmt;
    tWeightCharges += weightCharges;
    tNet += rowTotal;
  });

  sgst.value = tSGST.toFixed(2);
  cgst.value = tCGST.toFixed(2);
  totalGst.value = tGST.toFixed(2);
  shortageAmt.value = tShort.toFixed(2);
  chotariAmt.value = tChotari.toFixed(2);
  weightChargeAmt.value = tWeightCharges.toFixed(2);
  netTotal.value = tNet.toFixed(2);
}

// Collect
function collectData() {
  let items = [];
  document.querySelectorAll("#productBody tr").forEach(row => {
    items.push({
      itemName: row.querySelector(".itemName").value,
      weightKg: parseFloat(row.querySelector(".weightKg").value) || 0,
      pricePerKg: parseFloat(row.querySelector(".pricePerKg").value) || 0,
      gstPercent: parseFloat(row.querySelector(".gstPercent").value) || 0,
      shortageKg: parseFloat(row.querySelector(".shortageKg").value) || 0,
      chotariPercent: parseFloat(row.querySelector(".chotariPercent").value) || 0,
      weightCharges: parseFloat(row.querySelector(".weightCharges").value) || 0
    });
  });

  return {
    id: invoiceId,
    supplierFirmOwnerName: supplierName.value,
    supplierMobile: supplierMobile.value,
    supplierAddress: supplierAddress.value,

    companyId: 1,

    items: items,
    itemsJson: JSON.stringify(items),

    sgst: parseFloat(sgst.value),
    cgst: parseFloat(cgst.value),
    weightShortageAmount: parseFloat(shortageAmt.value),
    chotariAmount: parseFloat(chotariAmt.value),
    weightChargesDeducted: parseFloat(weightChargeAmt.value),
    finalNetTotal: parseFloat(netTotal.value),

    vehicleNumber: vehicleNo.value,
    driverContactNumber: driverMobile.value,
    driverName: driverName.value
  };
}

// Update
updateBtn.addEventListener("click", () => {
  let data = collectData();
  axios.put(`http://localhost:8080/api/purchases/${invoiceId}`, data)
    .then(() => {
      alert("Invoice Updated Successfully!");
      window.location.href = "Purchase_invoices_List.html";
    });
});

// Initial Load
document.addEventListener("DOMContentLoaded", () => {
  loadCompany();
  loadInvoice();
  document.getElementById("addRowBtn").addEventListener("click", () => addRow());
});
</script>

</body>
</html>
